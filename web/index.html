<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Numel AI Playground</title>
		<style>
			body {
				font-family: system-ui, -apple-system, sans-serif;
				margin: 0;
				padding: 20px 20px 60px 20px;
				line-height: 1.6;
				background: #f8f9fa;
				background: #1F1E1D;
				gap: 20px;
				height: 100vh;
				box-sizing: border-box;
				display: flex;
			}

			.main-content {
				display: flex;
				gap: 20px;
				flex: 1;
				min-height: 0;
			}

			* {
				color: #b6b6b6;
			}

			select {
				background: #262624;
				border: 1px solid #555;
				border-radius: 6px;
				padding: 5px;
			}

			.container {
				background: white;
				background: #262624;
				border-radius: 6px;
				padding: 20px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				flex: 0 0 400px;
				display: flex;
				flex-direction: column;
				min-height: 0;
			}

			.canvas-container {
				background: #262624;
				border-radius: 6px;
				padding: 20px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				flex: 1;
				display: flex;
				flex-direction: column;
				min-height: 0;
				overflow: hidden;
			}

			.chat-container {
				flex: 1;
				border: 1px solid #555;
				border-radius: 6px;
				overflow-y: auto;
				padding: 15px;
				background: #fafafa;
				background: #30302E;
				margin-bottom: 15px;
				min-height: 200px;
			}

			.message {
				margin: 10px 0;
				padding: 8px 12px;
				border-radius: 8px;
				max-width: 80%;
			}

			.message.user {
				background: #007bff;
				color: white;
				margin-left: auto;
			}

			.message.agent {
				background: #28a745;
				color: white;
			}

			.message.system {
				background: #6c757d;
				color: white;
				font-size: 0.9em;
			}

			.message.system-error {
				background: #6c757d;
				color: white;
				font-size: 0.9em;
			}

			.message.ui {
				background: #365138;
				color: white;
				font-size: 0.9em;
			}

			.input-group {
				display: flex;
				gap: 10px;
			}

			#messageInput {
				flex: 1;
				padding: 10px;
				border: 1px solid #555;
				border-radius: 6px;
				font-size: 16px;
			}

			/* Canvas wrapper to handle border separately */
			.canvas-wrapper {
				flex: 1;
				border: 1px solid #555;
				border-radius: 6px;
				overflow: hidden;
				position: relative;
				display: flex;
			}

			#numelCanvas {
				display: block;
				width: 100%;
				height: 100%;
			}

			button {
				padding: 10px 20px;
				background: #007bff;
				color: white;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 16px;
			}

			button:hover {
				background: #0056b3;
			}

			button:disabled {
				background: #6c757d;
				cursor: not-allowed;
			}

			.status.idle { color: #bea7ff; }
			.status.connecting { color: #b18606; }
			.status.connected { color: #198b33; }
			.status.disconnected { color: #bb0f20; }

			.config {
				margin-bottom: 15px;
				padding: 10px;
				background: #e9ecef;
				background: #30302E;
				border-radius: 6px;
				border: 1px solid #555;
			}

			.config input {
				width: 100%;
				padding: 5px;
				border: 1px solid #555;
				border-radius: 4px;
				margin: 5px 0;
				background: #262624;
			}

			.loading {
				display: none;
				color: #6c757d;
				font-style: italic;
			}

			.footer {
				padding: 10px 0 20px 0;
				text-align: center;
				font-size: 0.8em;
				position: absolute;
				bottom: 0;
				left: 50%;
				transform: translateX(-50%);
			}

			.centered {
				text-align: center;
			}

			.app-name {
				color: orange;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="litegraph.css">
		<script type="text/javascript" src="litegraph.js"></script>
	</head>
	<body>
		<div class="container">
			<h1 class="centered"><span class="app-name">Numel AI</span> Playground</h1>

			<div class="config">
				<table>
					<tr>
						<td><label for="serverUrl">URL:</label></td>
						<td><input type="url" id="serverUrl" value="http://localhost:8000" placeholder="http://localhost:8000" /></td>
					</tr>
					<tr>
						<td><label for="userId">User ID:</label></td>
						<td><input type="text" id="userId" value="" placeholder="Optional User ID" /></td>
					</tr>
					<tr>
						<td><label for="sessionId">Session ID:</label></td>
						<td><input type="text" id="sessionId" value="" placeholder="Optional Session ID" /></td>
					</tr>
					<tr>
						<td><label for="status">Status:</label></td>
						<td><div id="status" class="status idle">Not connected</div></td>
					</tr>
				</table>
			</div>

			<div class="config">
				<table>
					<tr>
						<td><label for="agents">Agent:</label></td>
						<td><select id="appAgentSelect" disabled><option value="-1"> - None - </option></select></td>
					</tr>
					<tr>
						<td><label for="debugMessage">Debug:</label></td>
						<td>
							<input type="checkbox" id="debugMessage" value="true" />
						</td>
					</tr>
				</table>
			</div>

			<div id="chatContainer" class="chat-container"></div>

			<div class="input-group">
				<input type="text" id="messageInput" placeholder="Type your message..." disabled>
				<button id="sendButton" onclick="sendMessage()" disabled>Send</button>
				<button id="clearChatButton" onclick="clearChat()">üóëÔ∏è</button>
				<button id="connectButton" onclick="toggleConnection()">Connect</button>
			</div>

			<div id="loading" class="loading">Loading AG-UI client...</div>
		</div>

		<div class="canvas-container">
			<h2 class="centered">Graph Editor</h2>
			<div class="canvas-wrapper">
				<canvas id="numelCanvas"></canvas>
			</div>
		</div>

		<div class="footer">
			&copy; 2025 - <a href="mailto:marco.dibenedetto@isti.cnr.it">Marco Di Benedetto</a>
		</div>

		<script type="text/javascript" src="dist/agui-client.bundle.js"></script>
		<script type="text/javascript" src="numel.js"></script>
		<script type="text/javascript" src="graph.js"></script>

		<script>
			const baseConfig = {
				"version"     : "1.0.0",
				"name"        : "Numel Playground",
				"description" : "Numel AI Playground",
				"author"      : "marco@numel.app",
				"backend"     : 0,
				"port"        : 8000,
				"seed"        : 42,
				"data"        : null,

				"backends" : [
					{
						"type"    : "agno",
						"version" : ""
					}
				],

				"models" : [
					{
						"type" : "openai",
						"id"   : "gpt-4"
					}
				],

				"embeddings" : [
					{
						"type" : "openai",
						"id"   : "gpt-4"
					}
				],

				"knowledge_dbs" : [
					{
						"type"        : "lancedb",
						"table_name"  : "knowledge",
						"db_url"      : "storage/knowledge/knowledge_lancedb_1",
						"search_type" : "hybrid"
					}
				],

				"knowledges" : [
					{
						"type" : "knowledge",
						"db"   : 0,
						"urls" : []
					}
				],

				"memory_dbs" : [
					{
						"type"       : "sqlite",
						"table_name" : "memory",
						"db_url"     : "storage/memory/memory_sqlite_1.db"
					}
				],

				"memories" : [
					{
						"type"       : "memory",
						"db"         : 0,
						"model"      : 0,
						"summarizer" : 0
					}
				],

				"storage_dbs" : [
					{
						"type"       : "sqlite",
						"table_name" : "session",
						"db_url"     : "storage/session/storage_sqlite_1.db"
					}
				],

				"storages" : [
					{
						"type"       : "storage",
						"db"         : 0,
						"model"      : 0,
						"summarizer" : 0
					}
				],

				"options" : [
					{
						"markdown"                         : true,
						"search_knowledge"                 : true,
						"enable_agentic_memory"            : true,
						"add_history_to_messages"          : true,
						"num_history_runs"                 : 3,
						"enable_session_summaries"         : true,
						"search_previous_sessions_history" : true,
						"num_history_sessions"             : 2,
						"show_tool_calls"                  : true,
						"tool_call_limit"                  : 5,
						"reasoning"                        : false
					}
				],

				"agents" : [
					{
						"version" : "1.0.0",
						"name"    : "Numel Assistant",
						"author"  : "user@numel.app",
						"data"    : null,

						"description"  : "Numel AI Assistant",
						"instructions" : [
							"Be helpful and informative",
							"Provide accurate and relevant information",
							"Use markdown formatting when appropriate"
						],

						"backend"   : 0,
						"model"     : 0,
						"knowledge" : [ 0 ],
						"memory"    : 0,
						"storage"   : 0,
						"options"   : 0,

						"tools" : [
							{
								"type" : "reasoning",
								"args" : null,
								"ref"  : null
							},
							{
								"type" : "web_search",
								"args" : {
									"max_results" : 5
								},
								"ref"  : null
							}
						]
					},
					{
						"version" : "1.0.0",
						"name"    : "Italian Assistant",
						"author"  : "italian@numel.app",
						"data"    : null,

						"description"  : "Italian AI Assistant",
						"instructions" : [
							"Always answer in Italian"
						],

						"backend" : 0,
						"model"   : {
							"type" : "openai",
							"id"   : "gpt-4o"
						}
					}
				]
			};

			const startMessage = "ü§ñ Hi, I am Numel, an AI playground. Ask me anything you want üôÇ";
			const endMessage   = "ü§ñ See you soon üëã";

			let aguiApp            = null;
			let graph              = null;
			let canvas             = null;
			let isConnected        = false;
			let agentPrevIndex     = -1;
			let agentCurrIndex     = -1;
			let messagePrevRole    = null;
			let messagePrevElement = null;

			const chatContainer   = document.getElementById("chatContainer");
			const messageInput    = document.getElementById("messageInput");
			const sendButton      = document.getElementById("sendButton");
			const connectButton   = document.getElementById("connectButton");
			const statusDiv       = document.getElementById("status");
			const serverUrlInput  = document.getElementById("serverUrl");
			const sessionIdInput  = document.getElementById("sessionId");
			const userIdInput     = document.getElementById("userId");
			const loadingDiv      = document.getElementById("loading");
			const systemMsgButton = document.getElementById("debugMessage");
			const appAgentSelect  = document.getElementById("appAgentSelect");
			const clearChatButton = document.getElementById("clearChatButton");

			function clearChat() {
				messagePrevRole         = null;
				messagePrevElement      = null;
				chatContainer.innerHTML = "";
			}

			function changeSystemVisibility() {
				const divs    = document.getElementsByClassName("message system");
				const display = this.checked ? "block" : "none";
				for (let dv of divs) {
					dv.style.display = display;
				}
			}

			function checkAGUILoaded() {
				if (typeof NumelApp !== "undefined") {
					loadingDiv.style.display = "none";
					addMessage("system", "‚úÖ NumelApp loaded successfully");
				} else {
					loadingDiv.style.display = "block";
					loadingDiv.textContent = "‚ùå Failed to load NumelApp.";
					addMessage("system-error", "‚ùå Error: NumelApp not found.");
				}
			}

			function enableAppInput(enable) {
				serverUrlInput  .disabled = !enable;
				sessionIdInput  .disabled = !enable;
				userIdInput     .disabled = !enable;
				appAgentSelect  .disabled = enable;
			}

			async function connect() {
				const serverUrl = serverUrlInput.value.trim();
				if (!serverUrl) {
					addMessage("system", "‚ö†Ô∏è Please enter a valid server URL");
					return;
				}

				addMessage("system", "‚åõ Connecting...");

				const userId    = userIdInput    .value.trim();
				const sessionId = sessionIdInput .value.trim();

				enableAppInput(false);

				updateStatus("connecting", "Connecting...");

				try {
					aguiApp = await NumelApp.connect(serverUrl, {
						userId     : userId,
						sessionId  : sessionId,
						config     : baseConfig,
						subscriber : { onEvent(params) { handleAGUIEvent(params.event); }, },
					});
					if (!aguiApp) {
						throw new Error("NumelApp initialization failed");
					}

					agentPrevIndex = -1;
					agentCurrIndex = 0;

					isConnected = true;

					setAppStatus();
					clearChat();
					updateStatus("connected", "AG-UI client ready");
					enableInput(true);
					connectButton.textContent = "Disconnect";
					addMessage("system", `‚úÖ AG-UI client initialized for ${serverUrl}`);
					addMessage("ui", startMessage);
				} catch (error) {
					console.error("Failed to initialize AG-UI client:", error);
					addMessage("system-error", `‚ùå Connection failed: ${error.message}<br/>`);
					updateStatus("disconnected", "Connection failed");
					enableAppInput(true);
				}
			}

			function disconnect() {
				if (aguiApp) {
					addMessage("system", "‚åõ Disconnecting...");
					aguiApp.disconnect();
					aguiApp = null;
				}

				isConnected = false;

				agentCurrIndex = -1;
				appAgentSelect.innerHTML = "<option value='-1'> - None - </option>";

				messageInput.value = "";

				updateStatus("disconnected", "Disconnected");
				enableInput(false);
				connectButton.textContent = "Connect";
				addMessage("system", "‚ÑπÔ∏è Disconnected from agent");
				addMessage("ui", endMessage);
				enableAppInput(true);
			}

			function handleAGUIEvent(event) {
				console.log("AG-UI Event:", event);

				if (!event) return;

				switch (event.type) {
					case NumelApp.EventType.TEXT_MESSAGE_CONTENT:
					case NumelApp.EventType.TEXT_MESSAGE_CHUNK:
						const content = event.delta || "No content";
						addMessage("agent", content);
						break;

					case NumelApp.EventType.TEXT_MESSAGE_START:
						addMessage("system", "ü§ñ Agent is responding...");
						break;

					case NumelApp.EventType.TEXT_MESSAGE_END:
						addMessage("system", "‚úÖ Response complete");
						break;

					case NumelApp.EventType.RUN_STARTED:
						addMessage("system", "üöÄ Agent run started");
						break;

					case NumelApp.EventType.RUN_FINISHED:
						addMessage("system", "üèÅ Agent run finished");
						break;

					case NumelApp.EventType.RUN_ERROR:
						addMessage("system-error", `‚ùå Error: ${event.error || "Unknown error"}`);
						break;

					case NumelApp.EventType.TOOL_CALL_START:
						addMessage("system", `üîß Tool call: ${event.tool_name || "unknown"}`);
						break;

					case NumelApp.EventType.TOOL_CALL_RESULT:
						addMessage("system", `‚úÖ Tool result received`);
						break;

					default:
						addMessage("system", `‚ÑπÔ∏è Event: ${event.type}`);
						console.log("Unhandled event:", event);
				}
			}

			async function sendMessage() {
				const message = messageInput.value.trim();
				if (!message || !isConnected || !aguiApp) return;

				addMessage("user", message);

				if (agentPrevIndex != agentCurrIndex) {
					agentPrevIndex = agentCurrIndex;
					agentName      = aguiApp.status["config"]["agents"][agentPrevIndex]["name"];
					addMessage("ui", `ü§ñ Talking to Agent "${agentName}"`);
				}

				messageInput    .value       = "";
				sendButton      .textContent = "Sending...";
				sendButton      .disabled    = true;
				connectButton   .disabled    = true;
				clearChatButton .disabled    = true;

				try {
					await aguiApp.send(message, agentPrevIndex);
				} catch (error) {
					console.error("Failed to send message:", error);
					addMessage("system-error", `‚ùå Failed to send message: ${error.message}`);
				} finally {
					sendButton      .textContent = "Send";
					sendButton      .disabled    = false;
					connectButton   .disabled    = false;
					clearChatButton .disabled    = false;
				}
			}

			function addMessage(role, content) {
				if (messagePrevRole != role) {
					const messageDiv = document.createElement("div");
					messageDiv.className = `message ${role}`;
					if (role == "system") {
						const display = systemMsgButton.checked ? "block" : "none";
						messageDiv.style.display = display;
					}
					messageDiv.innerHTML = "";
					chatContainer.appendChild(messageDiv);
					messagePrevRole    = role;
					messagePrevElement = messageDiv;
				} else if (role == "system") {
					content = `<br/>${content}`;
				}
				messagePrevElement.innerHTML += content;
				chatContainer.scrollTop = chatContainer.scrollHeight;
			}

			function updateStatus(type, message) {
				statusDiv.className = `status ${type}`;
				statusDiv.textContent = message;
			}

			function enableInput(enabled) {
				messageInput .disabled = !enabled;
				sendButton   .disabled = !enabled;
			}

			function toggleConnection() {
				if (isConnected) {
					disconnect();
				} else {
					connect();
				}
			}

			async function setAppStatus() {
				const status  = await aguiApp.getStatus();
				const agents  = status["config"]["agents"];
				let   content = "";
				if (agents.length == 0) {
					agentCurrIndex = -1;
					content        = "<option value='-1'> - None - </option>";
				}
				else {
					agentCurrIndex = 0;
					for (let i=0; i<agents.length; ++i) {
						const selected = (i == agentCurrIndex) ? " selected" : "";
						content += `<option value="${i}"${selected}>${agents[i]["name"]}</option>`;
					}
				}
				appAgentSelect.innerHTML = content;
				appAgentSelect.disabled  = false;
				return status;
			}

			function resizeCanvas() {
				const canvasEl = document.getElementById('numelCanvas');
				const wrapper = canvasEl.parentElement;
				const container = wrapper.parentElement;
				const header = container.querySelector('h2');
				
				// Calculate available space
				const containerStyle = window.getComputedStyle(container);
				const headerStyle = window.getComputedStyle(header);
				const wrapperStyle = window.getComputedStyle(wrapper);
				
				const containerPadding = parseFloat(containerStyle.paddingTop) + parseFloat(containerStyle.paddingBottom);
				const headerHeight = header.offsetHeight + parseFloat(headerStyle.marginTop) + parseFloat(headerStyle.marginBottom);
				
				// Get wrapper dimensions (which already accounts for borders)
				const availableWidth = wrapper.clientWidth;
				const availableHeight = wrapper.clientHeight;
				
				// Get device pixel ratio for high DPI displays
				const dpr = window.devicePixelRatio || 1;
				
				// Set internal canvas dimensions (accounting for DPI)
				canvasEl.width = availableWidth * dpr;
				canvasEl.height = availableHeight * dpr;
				
				// Set CSS dimensions to match the wrapper
				canvasEl.style.width = availableWidth + 'px';
				canvasEl.style.height = availableHeight + 'px';
				
				// Notify LiteGraph of canvas size change and DPI
				if (graph && graph.canvas) {
					// Scale the context for high DPI displays
					const ctx = canvasEl.getContext('2d');
					ctx.scale(dpr, dpr);
					
					// Update LiteGraph's internal dimensions
					graph.canvas.resize();
					
					// Force LiteGraph to recalculate mouse coordinates with the correct canvas dimensions
					graph.canvas.mouse = [0, 0];
					graph.canvas.graph_mouse = [0, 0];
					
					// Trigger a redraw
					graph.canvas.setDirty(true, true);
				}
			}

			serverUrlInput.addEventListener("change", (e) => {
				appAgentSelect.disabled  = true;
				appAgentSelect.innerHTML = "<option value='-1'> - None - </option>";
			});

			appAgentSelect.addEventListener("change", (e) => {
				agentCurrIndex = parseInt(e.target.value);
			});

			systemMsgButton.addEventListener("change", changeSystemVisibility);

			messageInput.addEventListener("keypress", (e) => {
				if (e.key === "Enter" && !e.shiftKey) {
					e.preventDefault();
					sendMessage();
				}
			});

			window.onload = () => {
				changeSystemVisibility.call(systemMsgButton);

				// Initialize graph
				graph = new NumelGraph("numelCanvas");
				
				// Override LiteGraph's mouse coordinate calculation
				if (graph && graph.canvas) {
					const originalProcessMouseDown = graph.canvas.processMouseDown;
					const originalProcessMouseMove = graph.canvas.processMouseMove;
					const originalProcessMouseUp = graph.canvas.processMouseUp;
					
					// Helper function to adjust mouse coordinates
					function adjustMouseEvent(e) {
						const canvasEl = document.getElementById('numelCanvas');
						const rect = canvasEl.getBoundingClientRect();
						const dpr = window.devicePixelRatio || 1;
						
						// Calculate the actual mouse position relative to the canvas
						e.canvasX = (e.clientX - rect.left) * dpr;
						e.canvasY = (e.clientY - rect.top) * dpr;
						e.localX = e.canvasX;
						e.localY = e.canvasY;
						
						// Update the offset values that LiteGraph uses
						e.offsetX = e.canvasX / dpr;
						e.offsetY = e.canvasY / dpr;
						
						return e;
					}
					
					// Override mouse event handlers
					graph.canvas.processMouseDown = function(e) {
						e = adjustMouseEvent(e);
						return originalProcessMouseDown.call(this, e);
					};
					
					graph.canvas.processMouseMove = function(e) {
						e = adjustMouseEvent(e);
						return originalProcessMouseMove.call(this, e);
					};
					
					graph.canvas.processMouseUp = function(e) {
						e = adjustMouseEvent(e);
						return originalProcessMouseUp.call(this, e);
					};
				}
				
				const nodeMap = graph.buildFromConfig(baseConfig);

				// Initial resize
				resizeCanvas();

				graph.layoutGraph("hierarchical");
				graph.centerGraph();
			};

			window.addEventListener('resize', resizeCanvas);

			document.addEventListener("DOMContentLoaded", () => {
				checkAGUILoaded();
			});

			// Add keyboard shortcuts for layout
			document.addEventListener("keydown", (e) => {
				if (e.target.tagName !== "INPUT" && e.target.tagName !== "TEXTAREA") {
					switch(e.key) {
						case "h":  // Hierarchical
							graph.layoutGraph("hierarchical");
							break;
						case "f":  // Force-directed
							graph.layoutGraph("force");
							break;
						case "c":  // Circular
							graph.layoutGraph("circular");
							break;
						case "g":  // Grid
							graph.layoutGraph("grid");
							break;
						case "a":  // Spacebar - center view
							e.preventDefault();
							graph.centerGraph();
							break;
					}

					// // examples:
					// // Apply hierarchical layout (best for config dependencies)
					// graph.layoutGraph('hierarchical', {
					// 	direction: 'LR',        // Left-to-right
					// 	layerSpacing: 450,      // Distance between layers
					// 	nodeSpacing: 200,       // Distance between nodes in same layer
					// 	alignLayers: true       // Center each layer
					// });

					// // Apply force-directed layout
					// graph.layoutGraph('force', {
					// 	iterations: 100,        // Simulation steps
					// 	nodeRepulsion: 1000,    // Repulsion strength
					// 	linkDistance: 200,      // Ideal link length
					// 	damping: 0.9           // Velocity damping
					// });

					// // Center view on all nodes
					// graph.centerGraph();
				}
			});
		</script>
	</body>
</html>
