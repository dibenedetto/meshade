<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Numel AI Playground</title>
	<style>
		body {
			font-family: system-ui, -apple-system, sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
			background: #f8f9fa;
		}

		.container {
			background: white;
			border-radius: 6px;
			padding: 20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}

		.chat-container {
			height: 400px;
			border: 1px solid #ddd;
			border-radius: 6px;
			overflow-y: auto;
			padding: 15px;
			background: #fafafa;
			margin-bottom: 15px;
		}

		.message {
			margin: 10px 0;
			padding: 8px 12px;
			border-radius: 8px;
			max-width: 80%;
		}

		.message.user {
			background: #007bff;
			color: white;
			margin-left: auto;
		}

		.message.agent {
			background: #28a745;
			color: white;
		}

		.message.system {
			background: #6c757d;
			color: white;
			font-size: 0.9em;
		}

		.message.system-error {
			background: #6c757d;
			color: white;
			font-size: 0.9em;
		}

		.message.ui {
			background: #365138;
			color: white;
			font-size: 0.9em;
		}

		.input-group {
			display: flex;
			gap: 10px;
		}

		#messageInput {
			flex: 1;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 6px;
			font-size: 16px;
		}

		button {
			padding: 10px 20px;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 16px;
		}

		button:hover {
			background: #0056b3;
		}

		button:disabled {
			background: #6c757d;
			cursor: not-allowed;
		}

		.status {
			margin: 5px 0;
			padding: 5px;
			border-radius: 4px;
			font-size: 0.9em;
			border: 1px solid #ddd;
		}

		.status.connected { background: #d4edda; color: #155724; }
		.status.connecting { background: #fff3cd; color: #856404; }
		.status.disconnected { background: #f8d7da; color: #721c24; }

		.config {
			margin-bottom: 15px;
			padding: 10px;
			background: #e9ecef;
			border-radius: 6px;
			border: 1px solid #ddd;
		}

		.config input {
			width: 100%;
			padding: 5px;
			border: 1px solid #ccc;
			border-radius: 4px;
			margin: 5px 0;
		}

		.loading {
			display: none;
			color: #6c757d;
			font-style: italic;
		}

		.footer {
			padding: 30px;
			text-align: center;
		}

		.centered {
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="container">
		<h1 class="centered">Numel AI Playground</h1>

		<div class="config">
			<table>
				<tr>
					<td><label for="serverUrl">URL:</label></td>
					<td><input type="url" id="serverUrl" value="http://localhost:8000" placeholder="http://localhost:8000" /></td>
				</tr>
				<tr>
					<td><label for="userId">User ID:</label></td>
					<td><input type="text" id="userId" value="" placeholder="Optional User ID" /></td>
				</tr>
				<tr>
					<td><label for="sessionId">Session ID:</label></td>
					<td><input type="text" id="sessionId" value="" placeholder="Optional Session ID" /></td>
				</tr>
				<tr>
					<td><label for="status">Status:</label></td>
					<td><div id="status" class="status disconnected">Not connected</div></td>
				</tr>
			</table>
		</div>

		<div class="config">
			<table>
				<tr>
					<td><label for="agents">Agent:</label></td>
					<td><select id="appAgentSelect"><option value="-1"> - None - </option></select></td>
				</tr>
				<tr>
					<td><label for="debugMessage">Debug:</label></td>
					<td><input type="checkbox" id="debugMessage" value="true" /></td>
				</tr>
			</table>
		</div>

		<div id="chatContainer" class="chat-container"></div>

		<div class="input-group">
			<input type="text" id="messageInput" placeholder="Type your message..." disabled>
			<button id="sendButton" onclick="sendMessage()" disabled>Send</button>
			<button id="connectButton" onclick="toggleConnection()">Connect</button>
			<button id="clearChatButton" onclick="clearChat()">&#xe020;</button>
		</div>

		<div id="loading" class="loading">Loading AG-UI client...</div>
	</div>

	<div class="footer">
		&copy; 2025 - Marco Di Benedetto
	</div>

	<!-- Include the bundled AG-UI client -->
	<script src="./dist/agui-client.bundle.js"></script>
	<script src="./numel.js"></script>

	<script>
		const startMessage = "ü§ñ Hi, I am Numel, an AI playground. Ask me anything you want üôÇ";
		const endMessage   = "ü§ñ See you soon üëã";

		let aguiApp     = null;
		let isConnected = false;

		let agentPrevIndex     = -1;
		let agentCurrIndex     = -1;

		let messagePrevRole    = null;
		let messagePrevElement = null;

		const chatContainer   = document.getElementById("chatContainer");
		const messageInput    = document.getElementById("messageInput");
		const sendButton      = document.getElementById("sendButton");
		const connectButton   = document.getElementById("connectButton");
		const statusDiv       = document.getElementById("status");
		const serverUrlInput  = document.getElementById("serverUrl");
		const sessionIdInput  = document.getElementById("sessionId");
		const userIdInput     = document.getElementById("userId");
		const loadingDiv      = document.getElementById("loading");
		const systemMsgButton = document.getElementById("debugMessage");
		const appAgentSelect  = document.getElementById("appAgentSelect");
		const clearChatButton = document.getElementById("clearChatButton");

		function clearChat() {
			messagePrevRole         = null;
			messagePrevElement      = null;
			chatContainer.innerHTML = "";
		}

		function changeSystemVisibility() {
			const divs    = document.getElementsByClassName("message system");
			const display = this.checked ? "block" : "none";
			for (let dv of divs) {
				dv.style.display = display;
			}
		}

		function checkAGUILoaded() {
			if (typeof AGUI !== "undefined" && AGUI.HttpAgent) {
				loadingDiv.style.display = "none";
				addMessage("system", "‚úÖ AG-UI client loaded successfully");
			} else {
				loadingDiv.style.display = "block";
				loadingDiv.textContent = "‚ùå Failed to load AG-UI client. Make sure agui-client.bundle.js is built and available.";
				addMessage("system-error", "‚ùå Error: AG-UI client not found. Please build the bundle first.");
			}
		}

		function enableAppInput(enable) {
			serverUrlInput  .disabled = !enable;
			sessionIdInput  .disabled = !enable;
			userIdInput     .disabled = !enable;
			appAgentSelect  .disabled = !enable;
		}

		async function connect() {
			if (typeof AGUI === "undefined" || !AGUI.HttpAgent) {
				addMessage("system", "‚ö†Ô∏è AG-UI client not loaded. Please build the bundle first.");
				return;
			}

			const serverUrl = serverUrlInput .value.trim();
			if (!serverUrl) {
				addMessage("system", "‚ö†Ô∏è Please enter a valid server URL");
				return;
			}

			const userId    = userIdInput    .value.trim();
			const sessionId = sessionIdInput .value.trim();

			enableAppInput(false);

			updateStatus("connecting", "Connecting...");

			try {
				const status = await getAppStatus();
				if (status["error"]) {
					throw "zune!";
				}

				aguiApp = await NumelApp.create(serverUrl, userId, sessionId,
				{
					onEvent(params) { handleAGUIEvent(params.event); },
				});

				agentPrevIndex = -1;
				agentCurrIndex = 0;

				isConnected = true;

				appAgentSelect.disabled = false;
				clearChat();
				updateStatus("connected", "AG-UI client ready");
				enableInput(true);
				connectButton.textContent = "Disconnect";
				addMessage("system", `‚úÖ AG-UI client initialized for ${serverUrl}`);
				addMessage("ui", startMessage);
			} catch (error) {
				console.error("Failed to initialize AG-UI client:", error);
				addMessage("system-error", `‚ùå Connection failed: ${error.message}<br/>`);
				updateStatus("disconnected", "Connection failed");
				enableAppInput(true);
			}
		}

		function disconnect() {
			aguiApp     = null;
			isConnected = false;

			messageInput.value = "";

			updateStatus("disconnected", "Disconnected");
			enableInput(false);
			connectButton.textContent = "Connect";
			addMessage("system", "‚ÑπÔ∏è Disconnected from agent");
			addMessage("ui", endMessage);
			enableAppInput(true);
		}

		function handleAGUIEvent(event) {
			console.log("AG-UI Event:", event);

			if (!event) return;

			switch (event.type) {
				case AGUI.EventType.TEXT_MESSAGE_CONTENT:
				case AGUI.EventType.TEXT_MESSAGE_CHUNK:
					const content = event.delta || "No content";
					addMessage("agent", content);
					break;

				case AGUI.EventType.TEXT_MESSAGE_START:
					addMessage("system", "ü§ñ Agent is responding...");
					break;

				case AGUI.EventType.TEXT_MESSAGE_END:
					addMessage("system", "‚úÖ Response complete");
					break;

				case AGUI.EventType.RUN_STARTED:
					addMessage("system", "üöÄ Agent run started");
					break;

				case AGUI.EventType.RUN_FINISHED:
					addMessage("system", "üèÅ Agent run finished");
					break;

				case AGUI.EventType.RUN_ERROR:
					addMessage("system-error", `‚ùå Error: ${event.error || "Unknown error"}`);
					break;

				case AGUI.EventType.TOOL_CALL_START:
					addMessage("system", `üîß Tool call: ${event.tool_name || "unknown"}`);
					break;

				case AGUI.EventType.TOOL_CALL_RESULT:
					addMessage("system", `‚úÖ Tool result received`);
					break;

				default:
					addMessage("system", `‚ÑπÔ∏è Event: ${event.type}`);
					console.log("Unhandled event:", event);
			}
		}

		async function sendMessage() {
			const message = messageInput.value.trim();
			if (!message || !isConnected || !aguiApp) return;

			addMessage("user", message);

			if (agentPrevIndex != agentCurrIndex) {
				agentPrevIndex = agentCurrIndex;
				agentName      = aguiApp.status["config"]["agents"][agentPrevIndex]["name"];
				addMessage("ui", `ü§ñ Talking to Agent "${agentName}"`);
			}

			messageInput    .value       = "";
			sendButton      .textContent = "Sending...";
			sendButton      .disabled    = true;
			connectButton   .disabled    = true;
			clearChatButton .disabled    = true;

			try {
				await aguiApp.send(message, agentPrevIndex);
			} catch (error) {
				console.error("Failed to send message:", error);
				addMessage("system-error", `‚ùå Failed to send message: ${error.message}`);
			} finally {
				sendButton      .textContent = "Send";
				sendButton      .disabled    = false;
				connectButton   .disabled    = false;
				clearChatButton .disabled    = false;
			}
		}

		function addMessage(role, content) {
			if (messagePrevRole != role) {
				const messageDiv = document.createElement("div");
				messageDiv.className = `message ${role}`;
				if (role == "system") {
					const display = systemMsgButton.checked ? "block" : "none";
					messageDiv.style.display = display;
				}
				messageDiv.innerHTML = content;
				chatContainer.appendChild(messageDiv);
				messagePrevRole    = role;
				messagePrevElement = messageDiv;
			} else {
				if (role == "system") {
					content = `<br/>${content}`;
				}
				messagePrevElement.innerHTML += content;
			}
			chatContainer.scrollTop = chatContainer.scrollHeight;
		}

		function updateStatus(type, message) {
			statusDiv.className = `status ${type}`;
			statusDiv.textContent = message;
		}

		function enableInput(enabled) {
			messageInput .disabled = !enabled;
			sendButton   .disabled = !enabled;
		}

		function toggleConnection() {
			if (isConnected) {
				disconnect();
			} else {
				connect();
			}
		}

		async function getAppStatus() {
			// sendEnabled = !sendButton.disabled;
			// enableInput    (false);
			// enableAppInput (false);

			const serverUrl = serverUrlInput.value.trim();
			const status    = await NumelApp.getStatus(serverUrl);
			const agents    = status["config"]["agents"];
			let   content   = "";

			if (agents.length == 0) {
				agentCurrIndex = -1;
				content        = "<option value='-1'> - None - </option>";
			}
			else {
				agentCurrIndex = 0;
				for (let i=0; i<agents.length; ++i) {
					const selected = (i == agentCurrIndex) ? " selected" : "";
					content += `<option value="${i}"${selected}>${agents[i]["name"]}</option>`;
				}
			}

			// enableInput    (true);
			// enableAppInput (true);

			appAgentSelect .innerHTML = content;
			appAgentSelect .disabled  = false;
			// connectButton  .disabled  = false;
			// sendButton     .disabled  = !sendEnabled;

			return status;
		}

		appAgentSelect.disabled  = true;

		serverUrlInput.addEventListener("change", (e) => {
			appAgentSelect.disabled  = true;
			appAgentSelect.innerHTML = "<option value='-1'> - None - </option>";
		});

		appAgentSelect.addEventListener("change", (e) => {
			agentCurrIndex = parseInt(e.target.value);
		});

		systemMsgButton.addEventListener("change", changeSystemVisibility);

		messageInput.addEventListener("keypress", (e) => {
			if (e.key === "Enter" && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});

		document.addEventListener("DOMContentLoaded", () => {
			checkAGUILoaded();
		});

		window.onload = () => {
			changeSystemVisibility.call(systemMsgButton);
		};
	</script>
</body>
</html>
