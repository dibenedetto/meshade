<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Numel AI Playground</title>
	<style>
		body {
			font-family: system-ui, -apple-system, sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
			background: #f8f9fa;
		}

		.container {
			background: white;
			border-radius: 8px;
			padding: 20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}

		.chat-container {
			height: 400px;
			border: 1px solid #ddd;
			border-radius: 6px;
			overflow-y: auto;
			padding: 15px;
			background: #fafafa;
			margin-bottom: 15px;
		}

		.message {
			margin: 10px 0;
			padding: 8px 12px;
			border-radius: 8px;
			max-width: 80%;
		}

		.message.user {
			background: #007bff;
			color: white;
			margin-left: auto;
		}

		.message.agent {
			background: #28a745;
			color: white;
		}

		.message.system {
			background: #6c757d;
			color: white;
			font-size: 0.9em;
		}

		.message.system-error {
			background: #6c757d;
			color: white;
			font-size: 0.9em;
		}

		.input-group {
			display: flex;
			gap: 10px;
		}

		#messageInput {
			flex: 1;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 6px;
			font-size: 16px;
		}

		button {
			padding: 10px 20px;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 16px;
		}

		button:hover {
			background: #0056b3;
		}

		button:disabled {
			background: #6c757d;
			cursor: not-allowed;
		}

		.status {
			margin: 15px 0;
			padding: 8px;
			border-radius: 4px;
			font-size: 0.9em;
		}

		.status.connected { background: #d4edda; color: #155724; }
		.status.connecting { background: #fff3cd; color: #856404; }
		.status.disconnected { background: #f8d7da; color: #721c24; }

		.config {
			margin-bottom: 15px;
			padding: 10px;
			background: #e9ecef;
			border-radius: 6px;
		}

		.config input {
			width: 100%;
			padding: 5px;
			border: 1px solid #ccc;
			border-radius: 4px;
			margin: 5px 0;
		}

		.loading {
			display: none;
			color: #6c757d;
			font-style: italic;
		}

		.input-row {
			display: flex;
			align-items: center; /* vertically align label and input */
			gap: 0.5em; /* space between label and input */
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Numel AI Playground</h1>

		<div class="config">
			<table>
				<tr>
					<td><label for="serverUrl">Agent Server URL:</label></td>
					<td><input type="url" id="serverUrl" value="http://localhost:8000" placeholder="http://localhost:8000" /></td>
				</tr>
				<tr>
					<td><label for="agents">Agents:</label></td>
					<td>
						<button id="appStatusButton" onclick="getAppStatus()">&#x21bb;</button>
						&nbsp;&nbsp;
						<select id="appAgentSelect"><option value="-1"> - None - </option></select>
					</td>
				</tr>
				<tr>
					<td><label for="sessionId">Session ID:</label></td>
					<td><input type="text" id="sessionId" value="" placeholder="Optional Session ID" /></td>
				</tr>
				<tr>
					<td><label for="userId">User ID:</label></td>
					<td><input type="text" id="userId" value="" placeholder="Optional User ID" /></td>
				</tr>
			</table>
		</div>

		<div id="status" class="status disconnected">Not connected</div>

		<div class="config">
			<table>
				<tr>
					<td><label for="systemMessage">Show System Messages:</label></td>
					<td><input type="checkbox" id="systemMessage" value="true" /></td>
				</tr>
			</table>
		</div>

		<div id="chatContainer" class="chat-container"></div>

		<div class="input-group">
			<input type="text" id="messageInput" placeholder="Type your message..." disabled>
			<button id="sendButton" onclick="sendMessage()" disabled>Send</button>
			<button id="connectButton" onclick="toggleConnection()">Connect</button>
		</div>

		<div id="loading" class="loading">Loading AG-UI client...</div>
	</div>

	<!-- Include the bundled AG-UI client -->
	<script src="dist/agui-client.bundle.js"></script>

	<script>
		class NumelApp {
			static _randomId() {
				const rmax = 1000000000.0;
				const id   = Math.floor(Math.random() * rmax);
				return id;
			}

			static _defaultStatus() {
				const status = {
					"agents" : [],
				};
				return status;
			}

			static async fetchStatus(url) {
				if (false)
				{
					return {
						"agents": [
							{
								"name": "Gre Vis",
								"port": 8001,
							},
						],
					};
				}
				const statusUrl = `${url}/status`;
				const status    = await fetch(statusUrl, {
					headers: {
						"Access-Control-Allow-Origin": "*",
					},
				}).then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error - status: ${response.status}`);
					}
					return response.json();
				})
				.catch(error => {
					console.error("Error fetching status:", error);
					return NumelApp._defaultStatus();
				});
				return status;
			}

			constructor(url, subscriber) {
				this.url        = url;
				this.subscriber = subscriber;
				this.status     = NumelApp._defaultStatus();
				this.agent      = null;
				this.agentIndex = -1;
			}

			clear() {
				this.disconnect();
				this.status     = NumelApp._defaultStatus();
				this.agent      = null;
				this.agentIndex = -1;
			}

			async updateStatus() {
				this.status = await NumelApp.fetchStatus(this.url);
				return this.status;
			}

			connect(index) {
				this.disconnect();
				const agents = this.status["agents"] ?? null;
				if (!agents || (index < 0) || (index >= agents.length)) {
					return false;
				}
				const info    = agents[index];
				const baseUrl = this.url.substr(0, this.url.lastIndexOf(":"));
				const port    = info["port"] + index;
				const url     = `${baseUrl}:${port}/agui`;
				const agent   = new AGUI.HttpAgent({
					name    : info["name"],
					url     : url,
					// headers : {
					// 	"Access-Control-Allow-Origin": "*",
					// },
				});
				if (this.subscriber) {
					agent.subscribe(this.subscriber);
				}
				this.agent    = agent
				this.agentIdx = index;
				return true;
			}

			disconnect() {
				if (!this.isConnected()) {
					return false;
				}
				this.agent    = null;
				this.agentIdx = -1;
				return true;
			}

			isConnected() {
				return (this.agent != null);
			}

			agentIndex() {
				return this.agentIdx;
			}

			async send(message) {
				const messageId   = `numel-message-${NumelApp._randomId()}`;
				const userMessage = {
					id      : messageId,
					role    : "user",
					content : message,
				};
				this.agent.setMessages([userMessage]);
				return await this.agent.runAgent({});
			}
		};

		let aguiApp     = null;
		let isConnected = false;
		let agentIndex  = -1;

		let messagePrevRole    = null;
		let messagePrevElement = null;

		// DOM elements
		const chatContainer   = document.getElementById("chatContainer");
		const messageInput    = document.getElementById("messageInput");
		const sendButton      = document.getElementById("sendButton");
		const connectButton   = document.getElementById("connectButton");
		const statusDiv       = document.getElementById("status");
		const serverUrlInput  = document.getElementById("serverUrl");
		const sessionIdInput  = document.getElementById("sessionId");
		const userIdInput     = document.getElementById("userId");
		const loadingDiv      = document.getElementById("loading");
		const systemMsgButton = document.getElementById("systemMessage");
		const appStatusButton = document.getElementById("appStatusButton");
		const appAgentSelect  = document.getElementById("appAgentSelect");

		function clearChat() {
			messagePrevRole         = null;
			messagePrevElement      = null;
			chatContainer.innerHTML = "";
		}

		function changeSystemVisibility() {
			const divs    = document.getElementsByClassName("message system");
			const display = this.checked ? "block" : "none";
			for (let dv of divs) {
				dv.style.display = display;
			}
		}

		// Check if AG-UI client is loaded
		function checkAGUILoaded() {
			if (typeof AGUI !== "undefined" && AGUI.HttpAgent) {
				loadingDiv.style.display = "none";
				addMessage("system", "‚úÖ AG-UI client loaded successfully");
			} else {
				loadingDiv.style.display = "block";
				loadingDiv.textContent = "‚ùå Failed to load AG-UI client. Make sure agui-client.bundle.js is built and available.";
				addMessage("system-error", "‚ùå Error: AG-UI client not found. Please build the bundle first.");
			}
		}

		function enableAppInput(enable) {
			serverUrlInput  .disabled = !enable;
			sessionIdInput  .disabled = !enable;
			userIdInput     .disabled = !enable;
			appStatusButton .disabled = !enable;
			appAgentSelect  .disabled = !enable;
		}

		async function connect() {
			const serverUrl = serverUrlInput.value.trim();
			const sessionId = sessionIdInput.value.trim();

			if (!serverUrl) {
				addMessage("system", "‚ö†Ô∏è Please enter a valid server URL");
				return;
			}

			if (typeof AGUI === "undefined" || !AGUI.HttpAgent) {
				addMessage("system", "‚ö†Ô∏è AG-UI client not loaded. Please build the bundle first.");
				return;
			}

			enableAppInput(false);

			updateStatus("connecting", "Connecting...");

			try {
				aguiApp = new NumelApp(serverUrl,
				{
					onRunInitialized          (params) { handleAGUIEvent(params.event); },
					onRunFailed               (params) { handleAGUIEvent(params.event); },
					onRunFinalized            (params) { handleAGUIEvent(params.event); },
					onEvent                   (params) { ; },
					onRunStartedEvent         (params) { handleAGUIEvent(params.event); },
					onRunFinishedEvent        (params) { handleAGUIEvent(params.event); },
					onRunErrorEvent           (params) { handleAGUIEvent(params.event); },
					onStepStartedEvent        (params) { handleAGUIEvent(params.event); },
					onStepFinishedEvent       (params) { handleAGUIEvent(params.event); },
					onTextMessageStartEvent   (params) { handleAGUIEvent(params.event); },
					onTextMessageContentEvent (params) { handleAGUIEvent(params.event); },
					onTextMessageEndEvent     (params) { handleAGUIEvent(params.event); },
					onToolCallStartEvent      (params) { handleAGUIEvent(params.event); },
					onToolCallArgsEvent       (params) { handleAGUIEvent(params.event); },
					onToolCallEndEvent        (params) { handleAGUIEvent(params.event); },
					onToolCallResultEvent     (params) { handleAGUIEvent(params.event); },
					onStateSnapshotEvent      (params) { handleAGUIEvent(params.event); },
					onStateDeltaEvent         (params) { handleAGUIEvent(params.event); },
					onMessagesSnapshotEvent   (params) { handleAGUIEvent(params.event); },
					onRawEvent                (params) { handleAGUIEvent(params.event); },
					onCustomEvent             (params) { handleAGUIEvent(params.event); },
					onMessagesChanged         (params) { handleAGUIEvent(params.event); },
					onStateChanged            (params) { handleAGUIEvent(params.event); },
					onNewMessage              (params) { handleAGUIEvent(params.event); },
					onNewToolCall             (params) { handleAGUIEvent(params.event); },
				});

				await aguiApp.updateStatus();
				aguiApp.connect(agentIndex);

				isConnected = true;

				clearChat();
				updateStatus("connected", "AG-UI client ready");
				enableInput(true);
				connectButton.textContent = "Disconnect";
				addMessage("system", `‚úÖ AG-UI client initialized for ${serverUrl}`);
				addMessage("agent", "Hi, I am Numel, a helpful AI playground. Ask me anything you want üôÇ");
			} catch (error) {
				console.error("Failed to initialize AG-UI client:", error);
				addMessage("system-error", `‚ùå Connection failed: ${error.message}<br/>`);
				updateStatus("disconnected", "Connection failed");
				enableAppInput(true);
			}
		}

		function disconnect() {
			if (aguiApp) {
				// aguiApp.disconnect();
				aguiApp = null;
			}

			isConnected = false;
			updateStatus("disconnected", "Disconnected");
			enableInput(false);
			connectButton.textContent = "Connect";
			addMessage("system", "‚ÑπÔ∏è Disconnected from agent");
			addMessage("agent", "See you soon üëã");
			enableAppInput(true);
		}

		function handleAGUIEvent(event) {
			console.log("AG-UI Event:", event);

			if (!event) return;

			// Handle different AG-UI event types
			switch (event.type) {
				case AGUI.EventType.TEXT_MESSAGE_CONTENT:
				case AGUI.EventType.TEXT_MESSAGE_CHUNK:
					const content = event.delta || "No content";
					addMessage("agent", content);
					break;

				case AGUI.EventType.TEXT_MESSAGE_START:
					addMessage("system", "ü§ñ Agent is responding...");
					break;

				case AGUI.EventType.TEXT_MESSAGE_END:
					addMessage("system", "‚úÖ Response complete");
					break;

				case AGUI.EventType.RUN_STARTED:
					addMessage("system", "üöÄ Agent run started");
					break;

				case AGUI.EventType.RUN_FINISHED:
					addMessage("system", "üèÅ Agent run finished");
					break;

				case AGUI.EventType.RUN_ERROR:
					addMessage("system-error", `‚ùå Error: ${event.error || "Unknown error"}`);
					break;

				case AGUI.EventType.TOOL_CALL_START:
					addMessage("system", `üîß Tool call: ${event.tool_name || "unknown"}`);
					break;

				case AGUI.EventType.TOOL_CALL_RESULT:
					addMessage("system", `‚úÖ Tool result received`);
					break;

				default:
					// Handle other AG-UI event types
					addMessage("system", `‚ÑπÔ∏è Event: ${event.type}`);
					console.log("Unhandled event:", event);
			}
		}

		async function sendMessage() {
			const message = messageInput.value.trim();
			if (!message || !isConnected || !aguiApp) return;

			addMessage("user", message);
			messageInput.value = "";
			sendButton.disabled = true;
			sendButton.textContent = "Sending...";

			try {
				await aguiApp.send(message);
			} catch (error) {
				console.error("Failed to send message:", error);
				addMessage("system-error", `‚ùå Failed to send message: ${error.message}`);
			} finally {
				sendButton.disabled = false;
				sendButton.textContent = "Send";
			}
		}

		function addMessage(role, content) {
			if (messagePrevRole != role) {
				const messageDiv = document.createElement("div");
				messageDiv.className = `message ${role}`;
				if (role == "system") {
					const display = systemMsgButton.checked ? "block" : "none";
					messageDiv.style.display = display;
				}
				messageDiv.innerHTML = content;
				chatContainer.appendChild(messageDiv);
				messagePrevRole    = role;
				messagePrevElement = messageDiv;
			} else {
				if (role == "system") {
					content = `<br/>${content}`;
				}
				messagePrevElement.innerHTML += content;
			}
			chatContainer.scrollTop = chatContainer.scrollHeight;
		}

		function updateStatus(type, message) {
			statusDiv.className = `status ${type}`;
			statusDiv.textContent = message;
		}

		function enableInput(enabled) {
			systemMsgButton .disabled = !enabled;
			messageInput    .disabled = !enabled;
			sendButton      .disabled = !enabled;
		}

		function toggleConnection() {
			if (isConnected) {
				disconnect();
			} else {
				connect();
			}
		}

		async function getAppStatus() {
			enableInput    (false);
			enableAppInput (false);

			const serverUrl = serverUrlInput.value.trim();
			const status    = await NumelApp.fetchStatus(serverUrl);
			const agents    = status["agents"];
			let   content   = "";
			if (agents.length == 0) {
				agentIndex = -1;
				content    = "<option value='-1'> - None - </option>";
			}
			else {
				agentIndex = 0;
				for (let i=0; i<agents.length; ++i) {
					let selected = (i == agentIndex) ? " selected" : "";
					content += `<option value="${i}"${selected}>${agents[i]["name"]}</option>`;
				}
			}

			enableInput    (true);
			enableAppInput (true);

			appAgentSelect.innerHTML = content;
			appAgentSelect.disabled  = false;
		}

		appAgentSelect.disabled  = true;

		// Event listeners
		serverUrlInput.addEventListener("change", (e) => {
			appAgentSelect.disabled  = true;
			appAgentSelect.innerHTML = "<option value='-1'> - None - </option>";
		});

		appAgentSelect.addEventListener("change", (e) => {
			agentIndex = this.value;
		});

		systemMsgButton.addEventListener("change", changeSystemVisibility);

		messageInput.addEventListener("keypress", (e) => {
			if (e.key === "Enter" && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});

		// Initialize when page loads
		document.addEventListener("DOMContentLoaded", () => {
			checkAGUILoaded();
		});

		window.onload = () => {
			changeSystemVisibility.call(systemMsgButton);
		};
	</script>
</body>
</html>
